<div class="patient-detail-container" *ngIf="patient">

  <div *ngIf="toastMessage"
       class="alert glass-card alert-toast"
       [ngClass]="toastType === 'success' ? 'alert-success' : 'alert-danger'"
       role="alert">
    <i class="bi" [ngClass]="toastType === 'success' ? 'bi-check-circle-fill me-2' : 'bi-exclamation-circle-fill me-2'"></i>
    {{ toastMessage }}
  </div>

  <div *ngIf="loading" class="loading-state glass-card p-5 text-center">
    <div class="spinner-border text-primary mb-3" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mb-0">Loading patient details...</p>
  </div>

  <div class="patient-header mb-5" *ngIf="!loading">
    <div class="patient-info-header">
      <h2 class="patient-name-title mb-2">
        <i class="bi bi-person-circle me-2"></i>
        {{ patient.name }}
      </h2>
      <div class="patient-info-badges">
        <span class="badge patient-info-badge">
          <i class="bi bi-calendar me-1"></i>
          Age: {{ patient.age }}
        </span>
        <span *ngIf="patient.condition" class="badge patient-info-badge">
          <i class="bi bi-heart-pulse me-1"></i>
          {{ patient.condition }}
        </span>
        <span *ngIf="patient.town" class="badge patient-info-badge">
          <i class="bi bi-geo-alt me-1"></i>
          {{ patient.town }}
        </span>
      </div>
    </div>

    <div class="patient-summary">
      <div class="summary-card glass-card">
        <div class="summary-header">
          <i class="bi bi-clipboard-data me-2"></i>
          <strong>Medical Summary</strong>
        </div>
        <div class="summary-stats">
          <div class="stat-item">
            <div class="stat-value">{{ appointments.length }}</div>
            <div class="stat-label">Appointments</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ prescriptions.length }}</div>
            <div class="stat-label">Prescriptions</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ careplans.length }}</div>
            <div class="stat-label">Care Plans</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="patient-content" *ngIf="!loading">
    
    <div class="row g-4">

      <div class="col-lg-8">

        <div class="glass-card p-4 mb-4">
          <div class="section-header d-flex justify-content-between align-items-center mb-4">
            <h4 class="section-title mb-0">
              <i class="bi bi-calendar-week me-2"></i>
              Appointments
            </h4>
            <span *ngIf="editingAppointmentId" class="badge edit-badge">
              <i class="bi bi-pencil me-1"></i>
              Editing
            </span>
          </div>

          @if (appointments.length === 0) {
            <div class="empty-state text-center py-4">
              <i class="bi bi-calendar display-4 text-muted mb-3"></i>
              <p class="text-muted mb-0">No appointments recorded</p>
            </div>
          } @else {

            <div class="appointments-list">
              @for (a of (showAllAppointments ? appointments : appointments.slice(0, 3)); track a._id) {
                <div class="appointment-item glass-card"
                    [appHighlightUrgent]="a.status === 'requested'">

                  <div class="appointment-header d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <div class="appointment-date">
                        <i class="bi bi-calendar-check me-2"></i>
                        <strong>{{ fmt(a.date) }}</strong>
                      </div>
                      <div class="appointment-doctor mt-2">
                        <span class="badge doctor-badge">
                          <i class="bi bi-person-badge me-1"></i>
                          Dr. {{ a.doctor || 'Not assigned' }}
                        </span>
                      </div>
                    </div>
                    <span class="badge appointment-status" [ngClass]="badge(a.status)">
                      {{ a.status }}
                    </span>
                  </div>
                  
                  @if (a.notes) {
                    <div class="appointment-notes mt-3">
                      <p class="mb-0 text-muted">{{ a.notes }}</p>
                    </div>
                  }

                  <div class="appointment-actions mt-3">
                    <button class="btn action-btn edit-btn"
                            (click)="startEditAppointment(a)">
                      <i class="bi bi-pencil me-1"></i>
                      Edit
                    </button>
                    <button class="btn action-btn complete-btn"
                            (click)="updateAppointmentStatus(a, 'completed')">
                      <i class="bi bi-check-circle me-1"></i>
                      Complete
                    </button>
                    <button class="btn action-btn cancel-btn"
                            (click)="updateAppointmentStatus(a, 'cancelled')">
                      <i class="bi bi-x-circle me-1"></i>
                      Cancel
                    </button>
                    <button class="btn action-btn delete-btn"
                            (click)="deleteAppointment(a)">
                      <i class="bi bi-trash me-1"></i>
                      Delete
                    </button>
                  </div>
                </div>
              }
            </div>

            @if (appointments.length > 3) {
              <button class="btn view-more-btn w-100 mt-3"
                      (click)="showAllAppointments = !showAllAppointments">
                <i class="bi" [ngClass]="showAllAppointments ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                {{ showAllAppointments ? 'Show Less' : 'Show More' }}
              </button>
            }
          }

          <hr class="my-4">

          <div class="appointment-form">
            <h5 class="form-title">
              <i class="bi" [ngClass]="editingAppointmentId ? 'bi-pencil' : 'bi-plus-circle'"></i>
              {{ editingAppointmentId ? 'Update Appointment' : 'Add New Appointment' }}
            </h5>
            
            <form [formGroup]="appointmentForm" (ngSubmit)="saveAppointment()" class="mt-3">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Doctor Name</label>
                  <input class="form-control form-input" formControlName="doctor" placeholder="Dr. Smith">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Date</label>
                  <input type="date" formControlName="date" class="form-control form-input">
                </div>

                <div class="col-12">
                  <label class="form-label">Notes</label>
                  <textarea class="form-control form-textarea" formControlName="notes" 
                            placeholder="Appointment notes..."></textarea>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Status</label>
                  <select class="form-control form-select" formControlName="status">
                    <option value="scheduled">Scheduled</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>

                <div class="col-12 mt-3">
                  <button class="btn primary-btn me-2"
                          [disabled]="appointmentForm.invalid">
                    <i class="bi" [ngClass]="editingAppointmentId ? 'bi-save' : 'bi-plus-circle'"></i>
                    {{ editingAppointmentId ? 'Save Changes' : 'Add Appointment' }}
                  </button>

                  <button *ngIf="editingAppointmentId"
                          type="button"
                          class="btn secondary-btn"
                          (click)="cancelEditAppointment()">
                    <i class="bi bi-x-circle me-1"></i>
                    Cancel Edit
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="glass-card p-4 mb-4">
          <div class="section-header d-flex justify-content-between align-items-center mb-4">
            <h4 class="section-title mb-0">
              <i class="bi bi-prescription2 me-2"></i>
              Prescriptions
            </h4>
            <span *ngIf="editingPrescriptionId" class="badge edit-badge">
              <i class="bi bi-pencil me-1"></i>
              Editing
            </span>
          </div>

          @if (prescriptions.length === 0) {
            <div class="empty-state text-center py-4">
              <i class="bi bi-capsule display-4 text-muted mb-3"></i>
              <p class="text-muted mb-0">No prescriptions recorded</p>
            </div>
          } @else {
            <div class="prescriptions-list">
              @for (rx of (showAllPrescriptions ? prescriptions : prescriptions.slice(0, 3)); track rx._id) {
                <div class="prescription-item glass-card">
                  <div class="prescription-header d-flex justify-content-between align-items-start mb-3">
                    <div>
                      <h6 class="prescription-name">{{ rx.name }}</h6>
                      <div class="prescription-dates text-muted">
                        <small>
                          <i class="bi bi-calendar-range me-1"></i>
                          {{ fmt(rx.start) }} - {{ fmt(rx.stop) }}
                        </small>
                      </div>
                    </div>
                    <span class="badge prescription-status" [ngClass]="badge(rx.status)">
                      {{ rx.status }}
                    </span>
                  </div>
                  
                  <div class="prescription-actions mt-3">
                    <button class="btn action-btn edit-btn"
                            (click)="startEditPrescription(rx)">
                      <i class="bi bi-pencil me-1"></i>
                      Edit
                    </button>
                    <button class="btn action-btn delete-btn"
                            (click)="deletePrescription(rx)">
                      <i class="bi bi-trash me-1"></i>
                      Delete
                    </button>
                  </div>
                </div>
              }
            </div>

            @if (prescriptions.length > 3) {
              <button class="btn view-more-btn w-100 mt-3"
                      (click)="showAllPrescriptions = !showAllPrescriptions">
                <i class="bi" [ngClass]="showAllPrescriptions ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                {{ showAllPrescriptions ? 'Show Less' : 'Show More' }}
              </button>
            }
          }

          <hr class="my-4">

          <div class="prescription-form">
            <h5 class="form-title">
              <i class="bi" [ngClass]="editingPrescriptionId ? 'bi-pencil' : 'bi-plus-circle'"></i>
              {{ editingPrescriptionId ? 'Update Prescription' : 'Add New Prescription' }}
            </h5>
            
            <form [formGroup]="prescriptionForm" (ngSubmit)="savePrescription()" class="mt-3">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Medication Name</label>
                  <input class="form-control form-input" formControlName="name" placeholder="e.g., Amoxicillin 500mg">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control form-input" formControlName="start">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Stop Date (optional)</label>
                  <input type="date" class="form-control form-input" formControlName="stop">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Status</label>
                  <select class="form-control form-select" formControlName="status">
                    <option value="active">Active</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>

                <div class="col-12 mt-3">
                  <button class="btn primary-btn me-2"
                          [disabled]="prescriptionForm.invalid">
                    <i class="bi" [ngClass]="editingPrescriptionId ? 'bi-save' : 'bi-plus-circle'"></i>
                    {{ editingPrescriptionId ? 'Save Changes' : 'Add Prescription' }}
                  </button>

                  <button *ngIf="editingPrescriptionId"
                          type="button"
                          class="btn secondary-btn"
                          (click)="cancelEditPrescription()">
                    <i class="bi bi-x-circle me-1"></i>
                    Cancel Edit
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <div class="glass-card p-4">
          <div class="section-header d-flex justify-content-between align-items-center mb-4">
            <h4 class="section-title mb-0">
              <i class="bi bi-clipboard-check me-2"></i>
              Care Plans
            </h4>
            <span *ngIf="editingCareplanId" class="badge edit-badge">
              <i class="bi bi-pencil me-1"></i>
              Editing
            </span>
          </div>

          @if (careplans.length === 0) {
            <div class="empty-state text-center py-4">
              <i class="bi bi-clipboard display-4 text-muted mb-3"></i>
              <p class="text-muted mb-0">No careplans recorded</p>
            </div>
          } @else {
            <div class="careplans-list">
              @for (c of (showAllCareplans ? careplans : careplans.slice(0, 3)); track c._id) {
                <div class="careplan-item glass-card">
                  <div class="careplan-header d-flex justify-content-between align-items-start mb-3">
                    <h6 class="careplan-name mb-0">{{ c.description || 'Care Plan' }}</h6>
                    <span class="badge careplan-status">Active</span>
                  </div>
                  <div class="careplan-dates text-muted">
                    <small>
                      <i class="bi bi-calendar-range me-1"></i>
                      {{ fmt(c.start) }} - {{ fmt(c.stop) }}
                    </small>
                  </div>
                  
                  <div class="careplan-actions mt-3">
                    <button class="btn action-btn edit-btn"
                            (click)="startEditCareplan(c)">
                      <i class="bi bi-pencil me-1"></i>
                      Edit
                    </button>
                    <button class="btn action-btn delete-btn"
                            (click)="deleteCareplan(c)">
                      <i class="bi bi-trash me-1"></i>
                      Delete
                    </button>
                  </div>
                </div>
              }
            </div>

            @if (careplans.length > 3) {
              <button class="btn view-more-btn w-100 mt-3"
                      (click)="showAllCareplans = !showAllCareplans">
                <i class="bi" [ngClass]="showAllCareplans ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                {{ showAllCareplans ? 'Show Less' : 'Show More' }}
              </button>
            }
          }

          <hr class="my-4">

        
          <div class="careplan-form">
            <h5 class="form-title">
              <i class="bi" [ngClass]="editingCareplanId ? 'bi-pencil' : 'bi-plus-circle'"></i>
              {{ editingCareplanId ? 'Update Careplan' : 'Add New Careplan' }}
            </h5>
            
            <form [formGroup]="careplanForm" (ngSubmit)="saveCareplan()" class="mt-3">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Description</label>
                  <input class="form-control form-input" formControlName="description" 
                         placeholder="e.g., Diabetes management plan">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control form-input" formControlName="start">
                </div>

                <div class="col-md-6">
                  <label class="form-label">Stop Date (optional)</label>
                  <input type="date" class="form-control form-input" formControlName="stop">
                </div>

                <div class="col-12 mt-3">
                  <button class="btn primary-btn me-2"
                          [disabled]="careplanForm.invalid">
                    <i class="bi" [ngClass]="editingCareplanId ? 'bi-save' : 'bi-plus-circle'"></i>
                    {{ editingCareplanId ? 'Save Changes' : 'Add Careplan' }}
                  </button>

                  <button *ngIf="editingCareplanId"
                          type="button"
                          class="btn secondary-btn"
                          (click)="cancelEditCareplan()">
                    <i class="bi bi-x-circle me-1"></i>
                    Cancel Edit
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      
      <div class="col-lg-4">
        
       
        <div class="glass-card p-4 mb-4">
          <h4 class="section-title mb-3">
            <i class="bi bi-geo-alt me-2"></i>
            Patient Location
          </h4>
          
          <div class="map-container">
            <google-map height="250px" width="100%" [options]="map_options">
              @for (m of map_markers; track m.lat + ',' + m.lng) {
  <map-marker [position]="m"></map-marker>
}

            </google-map>
          </div>
          
          <div class="mt-3">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Location: {{ patient.town || 'Not specified' }}
            </small>
          </div>
        </div>

       
        <div class="glass-card p-4">
          <h4 class="section-title mb-3">
            <i class="bi bi-clipboard2-pulse me-2"></i>
            Clinical Summary
          </h4>
          
          <div class="clinical-summary">
            <p class="text-muted">
              Patient presents with <strong>{{ patient.condition || 'no recorded condition' }}</strong>. 
              Treatment includes {{ prescriptions.length }} prescription(s) 
              and {{ careplans.length }} care plan(s).
            </p>
            
            
            <div class="summary-stats-small mt-4">
              <div class="stat-small">
                <div class="stat-small-value">{{ appointments.length }}</div>
                <div class="stat-small-label">Total Appts</div>
              </div>
              <div class="stat-small">
                <div class="stat-small-value">{{ prescriptions.length }}</div>
                <div class="stat-small-label">Prescriptions</div>
              </div>
              <div class="stat-small">
                <div class="stat-small-value">{{ careplans.length }}</div>
                <div class="stat-small-label">Care Plans</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

  </div>

</div>