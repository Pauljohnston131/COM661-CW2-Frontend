<!-- src/app/components/patient/patient.html -->
<div class="container mt-5 pt-5">

  @for (patient of patient_list; track patient.id) {

    <!-- PATIENT HEADER -->
    <div class="row mb-4">
      <div class="col-sm-12">
        <h2>{{ patient.name }}</h2>
        <p>
          <strong>Age:</strong> {{ patient.age }} <br>
          <strong>Age Group:</strong> {{ age_group }} <br>
          <strong>Condition:</strong> {{ patient.condition }} <br>
          <strong>Town:</strong> {{ town }} <br>
        </p>
      </div>
    </div>

    <div class="row">

      <!-- LEFT COLUMN -->
      <div class="col-md-6">

        <!-- APPOINTMENTS -->
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h4>Appointments</h4>

            @if (appointments.length === 0) {
              <p>No appointments recorded.</p>
            } @else {

              <ul class="list-group">
                <!-- SHOW ONLY THE FIRST 5 APPOINTMENTS -->
                @for (a of appointments.slice(0, 5); track a._id) {
                  <li class="list-group-item">
                    <strong>Date:</strong> {{ a.date }} <br>
                    <strong>Doctor:</strong> {{ a.doctor }} <br>
                    <strong>Notes:</strong> {{ a.notes }} <br>
                    <strong>Status:</strong> {{ a.status }} <br>

                    <!-- GP controls -->
                    <button class="btn btn-sm btn-outline-success me-2 mt-2"
                            (click)="updateAppointmentStatus(a, 'completed')">
                      Mark Completed
                    </button>
                    <button class="btn btn-sm btn-outline-warning me-2 mt-2"
                            (click)="updateAppointmentStatus(a, 'cancelled')">
                      Cancel
                    </button>
                    <button class="btn btn-sm btn-outline-danger mt-2"
                            (click)="deleteAppointment(a)">
                      Delete
                    </button>
                  </li>
                }
              </ul>

              <!-- Show More Button -->
              @if (appointments.length > 5) {
                <button class="btn btn-primary btn-sm mt-3"
                        (click)="showAllAppointments = !showAllAppointments">
                  {{ showAllAppointments ? 'Show Less' : 'Show More' }}
                </button>

                <!-- Render full list if showAllAppointments is TRUE -->
                @if (showAllAppointments) {
                  <ul class="list-group mt-3">
                    @for (a of appointments; track a._id) {
                      <li class="list-group-item">
                        <strong>Date:</strong> {{ a.date }} <br>
                        <strong>Doctor:</strong> {{ a.doctor }} <br>
                        <strong>Notes:</strong> {{ a.notes }} <br>
                        <strong>Status:</strong> {{ a.status }} <br>

                        <button class="btn btn-sm btn-outline-success me-2 mt-2"
                                (click)="updateAppointmentStatus(a, 'completed')">
                          Mark Completed
                        </button>
                        <button class="btn btn-sm btn-outline-warning me-2 mt-2"
                                (click)="updateAppointmentStatus(a, 'cancelled')">
                          Cancel
                        </button>
                        <button class="btn btn-sm btn-outline-danger mt-2"
                                (click)="deleteAppointment(a)">
                          Delete
                        </button>
                      </li>
                    }
                  </ul>
                }
              }
            }

            <!-- Add Appointment Form -->
            <hr class="mt-4 mb-3">

            <h5>Add Appointment</h5>

            <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()">
              <div class="form-group mb-3">
                <label for="doctor">Doctor</label>
                <input type="text"
                       id="doctor"
                       class="form-control"
                       formControlName="doctor"
                       [ngClass]="{ 'error': isInvalid('doctor') }">
              </div>

              <div class="form-group mb-3">
                <label for="date">Date</label>
                <input type="date"
                       id="date"
                       class="form-control"
                       formControlName="date"
                       [ngClass]="{ 'error': isInvalid('date') }">
              </div>

              <div class="form-group mb-3">
                <label for="notes">Notes</label>
                <textarea id="notes"
                          class="form-control"
                          formControlName="notes">
                </textarea>
              </div>

              <div class="form-group mb-3">
                <label for="status">Status</label>
                <select id="status"
                        class="form-control"
                        formControlName="status">
                  <option value="scheduled">Scheduled</option>
                  <option value="completed">Completed</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>

              <span *ngIf="isIncomplete()" class="text-danger">
                You must complete the required fields (doctor and date).
              </span>

              <button *ngIf="!isIncomplete()"
                      class="btn btn-primary mt-2"
                      type="submit">
                Submit
              </button>
            </form>
          </div>
        </div>

        <!-- PRESCRIPTIONS -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h4>Prescriptions</h4>

    @if (prescriptions.length === 0) {
      <p>No prescriptions recorded.</p>
    } @else {

      <ul class="list-group mb-3">
        @for (rx of (showAllPrescriptions ? prescriptions : prescriptions.slice(0, 5)); track rx._id) {
          <li class="list-group-item">
            <strong>Medication:</strong> {{ rx.name }} <br>
            <strong>Start:</strong> {{ rx.start }} <br>
            <strong>Stop:</strong> {{ rx.stop }} <br>
            <strong>Status:</strong> {{ rx.status }} <br>

            <button class="btn btn-sm btn-outline-danger mt-2"
                    (click)="deletePrescription(rx)">
              Delete
            </button>
          </li>
        }
      </ul>

      @if (prescriptions.length > 5) {
        <button class="btn btn-primary btn-sm mt-2"
                (click)="showAllPrescriptions = !showAllPrescriptions">
          {{ showAllPrescriptions ? 'Show Less' : 'Show More' }}
        </button>
      }
    }

    <!-- Add Prescription Form -->
    <h5 class="mt-4">Add Prescription</h5>
    <form [formGroup]="prescriptionForm" (ngSubmit)="addPrescription()">
      <div class="form-group mb-2">
        <label>Medication</label>
        <input class="form-control" formControlName="medication">
      </div>
      <div class="form-group mb-2">
        <label>Dosage</label>
        <input class="form-control" formControlName="dosage">
      </div>
      <div class="form-group mb-2">
        <label>Status</label>
        <select class="form-control" formControlName="status">
          <option value="active">Active</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <button class="btn btn-primary mt-2" type="submit"
              [disabled]="prescriptionForm.invalid">
        Add Prescription
      </button>
    </form>

  </div>
</div>
<!-- CAREPLANS -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h4>Care Plans</h4>

    @if (careplans.length === 0) {
      <p>No careplans available.</p>
    } @else {

      <ul class="list-group mb-3">
        @for (c of (showAllCareplans ? careplans : careplans.slice(0, 5)); track c._id) {
          <li class="list-group-item">
            <strong>Description:</strong> {{ c.description }} <br>
            <strong>Start:</strong> {{ c.start }} <br>
            <strong>Stop:</strong> {{ c.stop }} <br>

            <button class="btn btn-sm btn-outline-danger mt-2"
                    (click)="deleteCareplan(c)">
              Delete
            </button>
          </li>
        }
      </ul>

      @if (careplans.length > 5) {
        <button class="btn btn-primary btn-sm mt-2"
                (click)="showAllCareplans = !showAllCareplans">
          {{ showAllCareplans ? 'Show Less' : 'Show More' }}
        </button>
      }
    }

    <!-- Add Careplan Form -->
    <h5 class="mt-4">Add Care Plan</h5>
    <form [formGroup]="careplanForm" (ngSubmit)="addCareplan()">
      <div class="form-group mb-2">
        <label>Name</label>
        <input class="form-control" formControlName="name">
      </div>
      <div class="form-group mb-2">
        <label>Goal</label>
        <input class="form-control" formControlName="goal">
      </div>
      <div class="form-group mb-2">
        <label>Status</label>
        <select class="form-control" formControlName="status">
          <option value="active">Active</option>
          <option value="completed">Completed</option>
          <option value="paused">Paused</option>
        </select>
      </div>
      <button class="btn btn-primary mt-2" type="submit"
              [disabled]="careplanForm.invalid">
        Add Care Plan
      </button>
    </form>


  </div>
</div>


        <!-- GOOGLE MAP -->
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h4>Patient Location</h4>

            <google-map
              height="300px"
              width="100%"
              [options]="map_options">

              @for (marker of map_markers; track marker) {
                <map-advanced-marker
                  [position]="marker.position"
                  [title]="marker.title">
                </map-advanced-marker>
              }
            </google-map>
          </div>
        </div>

        <!-- CLINICAL SUMMARY -->
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h4>Clinical Summary</h4>
            <p>{{ loremText }}</p>
          </div>
        </div>

      </div>
    </div>

  }
</div>
