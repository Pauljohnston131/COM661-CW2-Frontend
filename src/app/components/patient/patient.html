<!-- src/app/components/patient/patient.html -->
<div class="container mt-5 pt-5" *ngIf="patient">

  <!-- TOAST -->
  <div *ngIf="toastMessage"
       class="alert"
       [ngClass]="toastType === 'success' ? 'alert-success' : 'alert-danger'"
       role="alert">
    {{ toastMessage }}
  </div>

  <!-- LOADING SPINNER -->
  <div *ngIf="loading" class="d-flex justify-content-center my-3">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- HEADER -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h2 class="mb-1">{{ patient.name }}</h2>
      <p class="text-muted mb-0">
        Age: <strong>{{ patient.age }}</strong> ·
        Condition: <strong>{{ patient.condition }}</strong> ·
        Town: <strong>{{ patient.town }}</strong>
      </p>
    </div>

    <!-- SUMMARY PANEL -->
    <div class="col-md-4 text-end">
      <div class="card shadow-sm">
        <div class="card-body small">
          <strong>Summary</strong>
          <div class="mt-2">
            <div>Appointments: {{ appointments.length }}</div>
            <div>Prescriptions: {{ prescriptions.length }}</div>
            <div>Careplans: {{ careplans.length }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN ROW -->
  <div class="row">

    <!-- LEFT COLUMN -->
    <div class="col-md-6">

      <!-- APPOINTMENTS -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">Appointments</h4>
            <span *ngIf="editingAppointmentId" class="badge bg-warning text-dark">
              Editing appointment
            </span>
          </div>

          @if (appointments.length === 0) {
            <p class="text-muted">No appointments recorded.</p>
          } @else {

            <ul class="list-group">
              @for (a of (showAllAppointments ? appointments : appointments.slice(0, 5)); track a._id) {
                <li class="list-group-item">
                  <strong>{{ fmt(a.date) }}</strong> <br>
                  Doctor: {{ a.doctor }} <br>
                  <small class="text-muted">{{ a.notes }}</small><br>

                  <span class="badge mt-2" [ngClass]="badge(a.status)">
                    {{ a.status }}
                  </span>

                  <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary me-2"
                            (click)="startEditAppointment(a)">
                      Edit
                    </button>

                    <button class="btn btn-sm btn-outline-success me-2"
                            (click)="updateAppointmentStatus(a, 'completed')">
                      Mark Completed
                    </button>

                    <button class="btn btn-sm btn-outline-warning me-2"
                            (click)="updateAppointmentStatus(a, 'cancelled')">
                      Cancel
                    </button>

                    <button class="btn btn-sm btn-outline-danger"
                            (click)="deleteAppointment(a)">
                      Delete
                    </button>
                  </div>
                </li>
              }
            </ul>

            @if (appointments.length > 5) {
              <button class="btn btn-primary btn-sm mt-3"
                      (click)="showAllAppointments = !showAllAppointments">
                {{ showAllAppointments ? 'Show Less' : 'Show More' }}
              </button>
            }
          }

          <hr class="my-4">

          <!-- ADD / EDIT APPOINTMENT -->
          <h5>{{ editingAppointmentId ? 'Update Appointment' : 'Add Appointment' }}</h5>
          <form [formGroup]="appointmentForm" (ngSubmit)="saveAppointment()">

            <div class="mb-2">
              <label>Doctor</label>
              <input class="form-control" formControlName="doctor">
            </div>

            <div class="mb-2">
              <label>Date</label>
              <input type="date" formControlName="date" class="form-control">
            </div>

            <div class="mb-2">
              <label>Notes</label>
              <textarea class="form-control" formControlName="notes"></textarea>
            </div>

            <div class="mb-2">
              <label>Status</label>
              <select class="form-control" formControlName="status">
                <option value="scheduled">Scheduled</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>

            <button class="btn btn-primary mt-2"
                    [disabled]="appointmentForm.invalid">
              {{ editingAppointmentId ? 'Save Changes' : 'Add Appointment' }}
            </button>

            <button *ngIf="editingAppointmentId"
                    type="button"
                    class="btn btn-outline-secondary mt-2 ms-2"
                    (click)="cancelEditAppointment()">
              Cancel Edit
            </button>

          </form>

        </div>
      </div>

      <!-- PRESCRIPTIONS -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">Prescriptions</h4>
            <span *ngIf="editingPrescriptionId" class="badge bg-warning text-dark">
              Editing prescription
            </span>
          </div>

          @if (prescriptions.length === 0) {
            <p class="text-muted">No prescriptions recorded.</p>
          } @else {
            <ul class="list-group">
              @for (rx of (showAllPrescriptions ? prescriptions : prescriptions.slice(0, 5)); track rx._id) {
                <li class="list-group-item">
                  <strong>{{ rx.name }}</strong><br>
                  Start: {{ fmt(rx.start) }}<br>
                  Stop: {{ fmt(rx.stop) }}<br>
                  Status:
                  <span class="badge bg-info">{{ rx.status }}</span>

                  <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary me-2"
                            (click)="startEditPrescription(rx)">
                      Edit
                    </button>

                    <button class="btn btn-sm btn-outline-danger"
                            (click)="deletePrescription(rx)">
                      Delete
                    </button>
                  </div>
                </li>
              }
            </ul>

            @if (prescriptions.length > 5) {
              <button class="btn btn-primary btn-sm mt-2"
                      (click)="showAllPrescriptions = !showAllPrescriptions">
                {{ showAllPrescriptions ? 'Show Less' : 'Show More' }}
              </button>
            }
          }

          <hr class="my-4">

          <!-- ADD / EDIT PRESCRIPTION -->
          <h5>{{ editingPrescriptionId ? 'Update Prescription' : 'Add Prescription' }}</h5>
          <form [formGroup]="prescriptionForm" (ngSubmit)="savePrescription()">

            <div class="mb-2">
              <label>Medication Name</label>
              <input class="form-control" formControlName="name">
            </div>

            <div class="mb-2">
              <label>Start Date</label>
              <input type="date" class="form-control" formControlName="start">
            </div>

            <div class="mb-2">
              <label>Stop Date (optional)</label>
              <input type="date" class="form-control" formControlName="stop">
            </div>

            <div class="mb-2">
              <label>Status</label>
              <select class="form-control" formControlName="status">
                <option value="active">Active</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>

            <button class="btn btn-primary mt-2"
                    [disabled]="prescriptionForm.invalid">
              {{ editingPrescriptionId ? 'Save Changes' : 'Add Prescription' }}
            </button>

            <button *ngIf="editingPrescriptionId"
                    type="button"
                    class="btn btn-outline-secondary mt-2 ms-2"
                    (click)="cancelEditPrescription()">
              Cancel Edit
            </button>

          </form>
        </div>
      </div>

      <!-- CAREPLANS -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="mb-0">Care Plans</h4>
            <span *ngIf="editingCareplanId" class="badge bg-warning text-dark">
              Editing careplan
            </span>
          </div>

          @if (careplans.length === 0) {
            <p class="text-muted">No careplans recorded.</p>
          } @else {
            <ul class="list-group">
              @for (c of (showAllCareplans ? careplans : careplans.slice(0, 5)); track c._id) {
                <li class="list-group-item">
                  <strong>{{ c.description }}</strong><br>
                  Start: {{ fmt(c.start) }}<br>
                  Stop: {{ fmt(c.stop) }}

                  <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary me-2"
                            (click)="startEditCareplan(c)">
                      Edit
                    </button>

                    <button class="btn btn-sm btn-outline-danger"
                            (click)="deleteCareplan(c)">
                      Delete
                    </button>
                  </div>
                </li>
              }
            </ul>

            @if (careplans.length > 5) {
              <button class="btn btn-primary btn-sm mt-2"
                      (click)="showAllCareplans = !showAllCareplans">
                {{ showAllCareplans ? 'Show Less' : 'Show More' }}
              </button>
            }
          }

          <hr class="my-4">

          <!-- ADD / EDIT CAREPLAN -->
          <h5>{{ editingCareplanId ? 'Update Careplan' : 'Add Careplan' }}</h5>
          <form [formGroup]="careplanForm" (ngSubmit)="saveCareplan()">

            <div class="mb-2">
              <label>Description</label>
              <input class="form-control" formControlName="description">
            </div>

            <div class="mb-2">
              <label>Start Date</label>
              <input type="date" class="form-control" formControlName="start">
            </div>

            <div class="mb-2">
              <label>Stop Date (optional)</label>
              <input type="date" class="form-control" formControlName="stop">
            </div>

            <button class="btn btn-primary mt-2"
                    [disabled]="careplanForm.invalid">
              {{ editingCareplanId ? 'Save Changes' : 'Add Careplan' }}
            </button>

            <button *ngIf="editingCareplanId"
                    type="button"
                    class="btn btn-outline-secondary mt-2 ms-2"
                    (click)="cancelEditCareplan()">
              Cancel Edit
            </button>

          </form>

        </div>
      </div>

    </div>

    <!-- RIGHT COLUMN -->
    <div class="col-md-6">

      <!-- MAP -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h4>Patient Location</h4>

          <google-map height="300px" width="100%" [options]="map_options">
            @for (m of map_markers; track m) {
              <!-- Use standard markers to avoid Map ID / Advanced Marker warning -->
              <map-marker [position]="m.position" [title]="m.title"></map-marker>
            }
          </google-map>
        </div>
      </div>

      <!-- CLINICAL SUMMARY -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h4>Clinical Summary</h4>
          <p>
            {{ patient.condition }} is currently being managed.
            {{ appointments.length }} appointments,
            {{ prescriptions.length }} prescriptions,
            and {{ careplans.length }} careplans have been recorded.
          </p>
        </div>
      </div>

    </div>

  </div>

</div>
